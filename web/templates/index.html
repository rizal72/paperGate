{% extends "base.html" %}

{% block title %}paperGate Web{% endblock %}

{% block header %}
    <div class="header">
        <div class="header-brand">
            <img src="{{ url_for('static', filename='papergate-icon.svg') }}" alt="paperGate" class="header-logo-icon">
            <img src="{{ url_for('static', filename='papergate-logo-full.svg') }}" alt="paperGate" class="header-logo-full">
            <div class="header-title">
                <h2 class="header-project-name">paperGate</h2>
                <h1>Control Panel</h1>
            </div>
        </div>
        <div class="header-links">
            <a href="https://github.com/rizal72/paperGate" target="_blank">GitHub</a>
        </div>
    </div>
{% endblock %}

{% block content %}
    <!-- Screen Controls -->
    <div class="card">
        <h2 class="card-title">Screen Controls</h2>
        <div class="controls-grid">
            <div class="button-group">
                <a class="btn btn-primary btn-with-icon" href="{{ url_for('previous_screen') }}">
                    <svg width="20" height="20" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 2L4 8l6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    </svg>
                    <span class="btn-text-mobile">Previous</span>
                </a>
                <a class="btn btn-accent btn-with-icon" href="{{ url_for('reload') }}">
                    <svg width="20" height="20" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13.65 2.35C12.2 0.9 10.21 0 8 0 3.58 0 0.01 3.58 0.01 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L9 7h7V0l-2.35 2.35z" fill="currentColor"/>
                    </svg>
                    <span class="btn-text-mobile">Reload</span>
                </a>
                <a class="btn btn-primary btn-with-icon" href="{{ url_for('next_screen') }}">
                    <svg width="20" height="20" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 2l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    </svg>
                    <span class="btn-text-mobile">Next</span>
                </a>
            </div>

            <div class="button-group-keys">
                <a class="btn btn-secondary" href="{{ url_for('button0') }}">KEY1</a>
                <a class="btn btn-secondary" href="{{ url_for('button1') }}">KEY2</a>
                <a class="btn btn-secondary" href="{{ url_for('button2') }}">KEY3</a>
                <a class="btn btn-secondary" href="{{ url_for('button3') }}">KEY4</a>
            </div>
        </div>
    </div>

    <!-- Current Display Preview -->
    <div class="card">
        <h2 class="card-title">Current Display</h2>
        <div class="display-preview">
            <div class="display-image-container">
                <img id="display-image"
                     src=""
                     alt="Loading display..."
                     onerror="this.alt='Display not available';">
            </div>
            <div class="display-info">
                <span class="current-screen-label">Screen: <strong id="current-screen-name">Loading...</strong></span>
                <button class="btn btn-secondary btn-sm btn-with-icon" onclick="refreshDisplay()" title="Refresh display">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13.65 2.35C12.2 0.9 10.21 0 8 0 3.58 0 0.01 3.58 0.01 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L9 7h7V0l-2.35 2.35z" fill="currentColor"/>
                    </svg>
                    Refresh
                </button>
                <label class="toggle-label">
                    <input type="checkbox" id="auto-refresh-toggle" checked onchange="toggleAutoRefresh()">
                    Auto-refresh (5s)
                </label>
                <span class="last-update" id="last-update">Last updated: never</span>
            </div>
        </div>
        <div id="loading-overlay" class="loading-overlay" style="display: none;">
            <div class="loading-spinner"></div>
            <div class="loading-text">Rendering screen...</div>
        </div>
    </div>

    <script>
    let autoRefreshInterval;
    let autoRefreshEnabled = true;
    let currentScreenName = null;
    let isLoading = false;

    async function getCurrentScreenName() {
        try {
            const response = await fetch('/current_screen_name');
            const data = await response.json();
            return data.screen || null;
        } catch (error) {
            console.error('Failed to get current screen name:', error);
            return null;
        }
    }

    async function refreshDisplay(forceRefresh = false) {
        if (isLoading && !forceRefresh) return; // Skip refresh if loading (unless forced)

        const newScreenName = await getCurrentScreenName();

        if (!newScreenName) {
            document.getElementById('display-image').alt = 'Display not available';
            document.getElementById('current-screen-name').textContent = 'Unknown';
            return;
        }

        currentScreenName = newScreenName;
        document.getElementById('current-screen-name').textContent = currentScreenName;

        const img = document.getElementById('display-image');
        const timestamp = new Date().getTime();

        console.log('Loading image: /display_screenshot/' + currentScreenName + '?t=' + timestamp);

        // Return a promise that resolves when image is loaded
        return new Promise((resolve) => {
            img.onload = () => {
                console.log('Image loaded successfully');
                document.getElementById('last-update').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
                resolve();
            };
            img.onerror = () => {
                console.log('Error loading image');
                resolve(); // Resolve anyway on error
            };
            img.src = `/display_screenshot/${currentScreenName}?t=${timestamp}`;
        });
    }

    function showLoading() {
        isLoading = true;
        document.getElementById('current-screen-name').textContent = 'Loading...';
        document.getElementById('last-update').textContent = 'Waiting for screen to render...';
        document.getElementById('loading-overlay').style.display = 'flex';

        // Stop auto-refresh during loading
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }

    function hideLoading() {
        isLoading = false;
        document.getElementById('loading-overlay').style.display = 'none';

        // Restart auto-refresh if enabled
        if (autoRefreshEnabled) {
            startAutoRefresh();
        }
    }

    // Wait for screen to actually change with simple delay strategy
    async function waitForScreenChange(oldScreenName, clickTime, maxAttempts = 40) {
        console.log('Waiting for screen to change from: ' + oldScreenName);

        let screenChanged = false;
        let newScreenName = oldScreenName;

        // First, wait for screen name to change
        for (let i = 0; i < 20; i++) {
            await new Promise(resolve => setTimeout(resolve, 500));
            newScreenName = await getCurrentScreenName();
            console.log('Attempt ' + (i+1) + ': current screen = ' + newScreenName);

            if (newScreenName && newScreenName !== oldScreenName) {
                console.log('Screen name changed to: ' + newScreenName);
                screenChanged = true;
                break;
            }
        }

        if (!screenChanged) {
            console.log('Screen name never changed, timing out');
            return false;
        }

        // Now wait additional time for e-paper display to refresh and screenshot to be saved
        // E-paper displays typically take 2-5 seconds to refresh
        console.log('Waiting 2 seconds for e-paper display to refresh and screenshot to be saved...');
        await new Promise(resolve => setTimeout(resolve, 2000));

        console.log('Screenshot should be ready now');
        return true;
    }

    // Intercept navigation button clicks to show loading
    function setupNavigationHandlers() {
        const navLinks = document.querySelectorAll('a[href*="next_screen"], a[href*="previous_screen"], a[href*="screen?screen="]');
        console.log('Found ' + navLinks.length + ' navigation links');
        navLinks.forEach(link => {
            link.addEventListener('click', async function(e) {
                e.preventDefault(); // Prevent default link behavior
                console.log('Navigation clicked!');

                const oldScreenName = currentScreenName;
                const clickTime = Date.now();
                showLoading();

                // Trigger the backend action
                const linkUrl = this.getAttribute('href');
                console.log('Fetching: ' + linkUrl);
                await fetch(linkUrl);

                // Wait for screen to actually change and screenshot to be ready
                await waitForScreenChange(oldScreenName, clickTime);

                // Force refresh display (bypass isLoading check) and hide loading
                await refreshDisplay(true);
                hideLoading();
            });
        });

        // Also intercept screen management form submissions
        const screenForms = document.querySelectorAll('form[action*="screen"]');
        console.log('Found ' + screenForms.length + ' screen forms');
        screenForms.forEach(form => {
            form.addEventListener('submit', async function(e) {
                e.preventDefault(); // Prevent default form submission
                console.log('Screen form submitted!');

                const oldScreenName = currentScreenName;
                const clickTime = Date.now();
                showLoading();

                // Get form action URL and parameters
                const formData = new FormData(form);
                const params = new URLSearchParams(formData);
                const actionUrl = form.getAttribute('action') + '?' + params.toString();

                console.log('Fetching: ' + actionUrl);
                await fetch(actionUrl);

                // Wait for screen to actually change and screenshot to be ready
                await waitForScreenChange(oldScreenName, clickTime);

                // Force refresh display (bypass isLoading check) and hide loading
                await refreshDisplay(true);
                hideLoading();
            });
        });
    }

    function toggleAutoRefresh() {
        autoRefreshEnabled = document.getElementById('auto-refresh-toggle').checked;
        if (autoRefreshEnabled) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    }

    function startAutoRefresh() {
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        autoRefreshInterval = setInterval(refreshDisplay, 5000);
    }

    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page loaded, setting up...');

        // Initial load
        refreshDisplay();

        // Setup navigation handlers
        setupNavigationHandlers();

        // Start auto-refresh
        if (autoRefreshEnabled) {
            startAutoRefresh();
        }
    });
    </script>

    <!-- Screen Management -->
    <div class="card">
        <h2 class="card-title">Screen Management</h2>

        <div class="info-box">
            <strong>Note:</strong> Adding or removing screens affects only the current session.
            Changes are temporary and will reset when paperGate restarts.
            Dropdown lists show the initial configuration and won't update after add/remove operations.
        </div>

        <form action="{{ url_for('screen') }}" method="get">
            <div class="form-group">
                <label class="form-label">Switch Screen</label>
                <div class="input-group">
                    <select class="form-control" name="screen" required>
                        <option value="" disabled selected>Select an active screen...</option>
                        {% for screen in active_screens %}
                        <option value="{{ screen }}">{{ screen }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-primary">Switch</button>
                </div>
                <span class="form-text">Switch to one of the currently active screens</span>
            </div>
        </form>

        <form action="{{ url_for('add_screen') }}" method="get">
            <div class="form-group">
                <label class="form-label">Add Screen</label>
                <div class="input-group">
                    <select class="form-control" name="screen" required{% if not available_screens %} disabled{% endif %}>
                        {% if available_screens %}
                        <option value="" disabled selected>Select a screen to add...</option>
                        {% for screen in available_screens %}
                        <option value="{{ screen }}">{{ screen }}</option>
                        {% endfor %}
                        {% else %}
                        <option value="" disabled selected>All screens are already active</option>
                        {% endif %}
                    </select>
                    <button type="submit" class="btn btn-primary"{% if not available_screens %} disabled{% endif %}>Add</button>
                </div>
                <span class="form-text">Load a screen module not yet active</span>
            </div>
        </form>

        <form action="{{ url_for('remove_screen') }}" method="get">
            <div class="form-group">
                <label class="form-label">Remove Screen</label>
                <div class="input-group">
                    <select class="form-control" name="screen" required>
                        <option value="" disabled selected>Select an active screen...</option>
                        {% for screen in active_screens %}
                        <option value="{{ screen }}">{{ screen }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-primary">Remove</button>
                </div>
                <span class="form-text">Unload one of the currently active screens</span>
            </div>
        </form>
    </div>

    <!-- System Information -->
    <div class="card">
        <h2 class="card-title">System Information</h2>
        <div class="system-info">
            <div class="info-row">
                <span class="info-label">Operating System</span>
                <span class="info-value">{{ system.dist() }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Model</span>
                <span class="info-value">{{ system.model() }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Temperature</span>
                <span class="info-value {% if system.temperature() > 70 %}temp-hot{% elif system.temperature() > 60 %}temp-warm{% else %}temp-normal{% endif %}">
                    {{ system.temperature() }}Â°C
                </span>
            </div>
            <div class="info-row">
                <span class="info-label">Network Sent</span>
                <span class="info-value">{{ system.network_total_sent() }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Network Received</span>
                <span class="info-value">{{ system.network_total_received() }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Hostname</span>
                <span class="info-value">{{ system.node() }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">IPv4 Address</span>
                <span class="info-value">{{ system.local_ipv4_address() }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Uptime</span>
                <span class="info-value">{{ system.uptime() }}</span>
            </div>
        </div>
    </div>
{% endblock %}
